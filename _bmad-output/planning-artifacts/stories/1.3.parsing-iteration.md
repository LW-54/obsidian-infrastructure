# Story 1.3: Core Config Parser & Iteration Loop

## Status
Ready for Review

## Story
**As a** Developer,
**I want** the script to parse the `staging-workflow.md` JSON and iterate through files,
**so that** I can verify the script "sees" the work to be done.

## Acceptance Criteria
1. Script correctly extracts the first JSON block found in `99-SYSTEM/infrastructure/staging-workflow.md`.
2. Script iterates through all `.md` files in the `01-STAGING` directory.
3. For each file, the script extracts the YAML frontmatter block (content between the first two `---` markers).
4. Script uses `jq` to parse the YAML-to-JSON (via a simple conversion or direct field extraction) to identify the "Type" field.
5. Script matches the extracted "Type" against the loaded configuration keys.
6. Script outputs (to stdout/log) the processing status for each file found.

## Tasks / Subtasks
- [x] Implement `load_config` function in `stage.sh`. (AC: 1)
  - [x] Use `sed` to extract content between first pair of triple backticks + json. [Source: Architecture#4]
  - [x] Validate extracted JSON with `jq .`.
- [x] Implement `extract_frontmatter` function. (AC: 3)
  - [x] Use POSIX `sed` to extract lines between first `---` and second `---`.
  - [x] Handle edge case: No frontmatter found.
- [x] Implement `get_metadata` function. (AC: 4)
  - [x] Convert YAML to JSON. (Strategy: minimal parsing or use a `sed` transform to make it JSON-ish for `jq`, or use `grep` if simple. PREFERRED: Use `sed` to convert `Key: Value` to `"Key": "Value"` wrapped in `{}` for `jq`, or rely on a helper if available. *Architecture Decision*: Since `yq` is absent, parsing simple YAML with `sed` to make it `jq`-compatible is acceptable for flat structures, or strictly reading specific lines.)
  - [x] *Refinement*: Actually, `jq -R` can read raw text. Better approach: Parse "Type: Value" lines using `grep` or `awk` if complex parsing isn't needed, OR use a lightweight `sed` pipeline to create valid JSON from simple flat YAML.
- [x] Implement `main` loop iteration. (AC: 2, 5, 6)
  - [x] Loop `for file in "$STAGING_DIR"/*.md`.
  - [x] Call extraction functions.
  - [x] Check if `Type` exists in Config keys (using `jq` check).
  - [x] Log "Processing <file>: Type <type> [MATCH|NO_MATCH]".

## Dev Notes
- **Previous Story Insights**: Story 1.2 generator creates valid/invalid notes. Use them!
- **File Locations**:
  - Script: `misc/obsidian/infrastructure/scripts/stage.sh`
- **Technical Constraints (Architecture)**:
  - **No `yq`**: We must parse YAML "Type" manually or creatively. Since we only need specific fields, `grep "^Type:"` is simplest/fastest, but `sed` to JSON allows `jq` validation later.
  - **Strategy**: 
    1. Extract Frontmatter.
    2. Use `sed` to turn `Key: Value` into `"Key": "Value"`.
    3. Feed to `jq` to handle quotes/spaces correctly.
- **Testing Requirements**:
  - Use `generate_test_data.sh` to create the environment.
  - Verify output log matches expected "Type" for each file.

### Testing
- **Verification steps**:
  1. `mkdir tmp_vault && cd tmp_vault`
  2. `sh ../misc/obsidian/infrastructure/scripts/generate_test_data.sh --target .`
  3. `export VAULT_ROOT="."`
  4. `sh ../misc/obsidian/infrastructure/scripts/stage.sh`
  5. Check logs for correct identification of "Idea", "Note", and "Missing Type".

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-19 | 1.0 | Initial draft for Parsing & Iteration | John (PM) |
| 2026-01-19 | 1.1 | Technical refinement for YAML parsing without yq | Bob (SM) |
| 2026-01-19 | 1.2 | Implemented parsing logic and iteration loop | James (Dev) |

## Dev Agent Record
### Agent Model Used
Gemini Pro 1.5

### Debug Log References
- Parsing logic tests: PASS (load_config, extract_frontmatter, get_metadata).
- E2E Iteration tests: PASS (Verified log output for MATCH/NO_MATCH/No Type).
- POSIX syntax check: PASS.

### Completion Notes List
- Implemented robust configuration extraction from Markdown using `sed`.
- Implemented YAML frontmatter extraction with safety check for closing delimiters.
- Implemented lightweight YAML-to-JSON conversion for flat metadata.
- Implemented file iteration loop with logging of processing status.
- Verified all ACs with a dedicated test suite `test-1.3-parsing.sh`.
- **DoD Summary**: All functional requirements met; POSIX compliance verified; comprehensive tests passing; edge cases (malformed frontmatter, missing fields) handled gracefully.

### File List
- misc/obsidian/infrastructure/scripts/stage.sh
- misc/obsidian/infrastructure/tests/test-1.3-parsing.sh

## QA Results
(pending)