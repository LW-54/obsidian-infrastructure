# Story 1.2: Test Environment Generator

## Status
Done

## Story
**As a** Developer,
**I want** a helper script to generate a dummy vault structure with valid and invalid test notes,
**so that** I can safely test `stage.sh` without risking my actual data.

## Acceptance Criteria
1. `generate_test_data.sh` exists and is executable in `misc/obsidian/infrastructure/scripts/`.
2. Script generates a standard vault folder structure: `01-STAGING`, `02-REFACTORING`, `03-ZETTELKASTEN/Ideas`, `03-ZETTELKASTEN/Notes`, `99-SYSTEM/infrastructure`.
3. Script generates a sample `99-SYSTEM/infrastructure/staging-workflow.md` with a JSON block containing at least two types:
    - `Idea`: destination `03-ZETTELKASTEN/Ideas`, fields: `Topic` (non-empty).
    - `Note`: destination `03-ZETTELKASTEN/Notes`, fields: `Status` (snippet: `[ "$Status" = "Active" ]`).
4. Script generates at least 5 test files in `01-STAGING`:
    - `valid-idea.md`: Valid "Idea" type with "Topic" field.
    - `valid-note.md`: Valid "Note" type with "Status: Active".
    - `missing-type.md`: YAML present but "Type" field missing.
    - `bad-frontmatter.md`: Unparseable YAML (e.g. missing closing `---`).
    - `collision-test.md`: Valid "Idea", but a file with the same name already exists in `03-ZETTELKASTEN/Ideas`.
5. Script is POSIX `sh` compliant.

## Tasks / Subtasks
- [x] Initialize `generate_test_data.sh` with `#!/bin/sh`. (AC: 1, 5)
- [x] Implement directory creation logic. (AC: 2)
  - [x] Create `01-STAGING`, `02-REFACTORING`.
  - [x] Create `03-ZETTELKASTEN/Ideas` and `03-ZETTELKASTEN/Notes`.
  - [x] Create `99-SYSTEM/infrastructure`.
- [x] Implement `staging-workflow.md` generation. (AC: 3)
  - [x] Use a heredoc to embed the JSON block.
  - [x] Ensure "Idea" and "Note" rules are present. [Source: Architecture#5]
- [x] Implement note generation logic. (AC: 4)
  - [x] Generate `valid-idea.md`, `valid-note.md`.
  - [x] Generate `missing-type.md`.
  - [x] Generate `bad-frontmatter.md` (e.g. `--- 
 Title: Bad 
 No end`).
  - [x] Generate `collision-test.md` in `01-STAGING` AND `03-ZETTELKASTEN/Ideas`.
- [x] Support `--target` argument to specify where to generate the vault (defaults to current dir).

## Dev Notes
- **Previous Story Insights**: 1.1 proved that `VAULT_ROOT` detection works. 1.2 should use a temporary directory as `VAULT_ROOT` for testing.
- **File Locations**:
  - Script: `misc/obsidian/infrastructure/scripts/generate_test_data.sh` [Source: architecture#7]
- **Technical Constraints (Architecture)**:
  - **Strict POSIX sh**: Avoid `mkdir -v` or other non-portable flags. Use `mkdir -p`. [Source: architecture#9]
  - **Data Integrity**: The script is a generator; ensure it doesn't delete existing files unless confirmed or in a specified target.
- **Testing Requirements**:
  - The script is "self-testing" in that its output is the test data for Story 1.3+.
  - Verification: Run script and `ls -R` the target.

### Testing
- **Verification steps**:
  1. `mkdir tmp_vault && cd tmp_vault`
  2. `sh ../misc/obsidian/infrastructure/scripts/generate_test_data.sh --target .`
  3. Verify `99-SYSTEM/infrastructure/staging-workflow.md` exists and contains JSON.
  4. Verify `01-STAGING` has 5 files.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-19 | 1.0 | Initial draft for Test Data Generator | John (PM) |
| 2026-01-19 | 1.1 | Refined with specific test cases and architecture alignment | Bob (SM) |

## Dev Agent Record
### Agent Model Used
Gemini Pro 1.5

### Debug Log References
- Script generation verification: PASS (Correct folder structure and file counts).
- Config generation verification: PASS (Valid JSON in markdown).
- POSIX syntax check: PASS (`sh -n`).

### Completion Notes List
- Implemented `generate_test_data.sh` covering all ACs.
- Ensured strict POSIX compliance.
- Verified config generation with correct JSON escaping (using single-quoted heredoc).
- Verified collision test setup.

### File List
- misc/obsidian/infrastructure/scripts/generate_test_data.sh

## QA Results

### Review Date: 2026-01-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The `generate_test_data.sh` script is well-implemented and meets all architectural requirements.
- **Robustness:** Handles target directory creation safely. Use of single-quoted heredocs for JSON content ensures zero leakage or accidental shell expansion of the test config.
- **Compliance:** Strict POSIX `sh` syntax verified.
- **Utility:** Provides a high-fidelity mock environment that will be critical for subsequent story validations (1.3+).

### Compliance Check

- Coding Standards: [x] Verified.
- Project Structure: [x] Verified.
- Testing Strategy: [x] Verified.
- All ACs Met: [x] Verified.

### Improvements Checklist

- [x] Verified heredoc safety for JSON.
- [x] Verified directory tree completeness.
- [x] Verified specific test file content (Collision, Bad Frontmatter).

### Gate Status

Gate: PASS → docs/qa/gates/1.2.test-data-generator-test-environment-generator.yml

### Recommended Status

[✓ Ready for Done]