# Story 1.5: File Operations (Move & Refactor)

## Status
Ready for Review

...

## Tasks / Subtasks
- [x] Implement `process_file` function in `stage.sh`. (AC: 1-8)
  - [x] Integrate validation logic from Story 1.4.
  - [x] If valid:
    - [x] Check for destination collision.
    - [x] If no collision, move file to destination (create dirs if needed).
    - [x] Log success.
  - [x] If invalid (or collision):
    - [x] Generate error callout string.
    - [x] Call `inject_error` function.
    - [x] Move file to `02-REFACTORING`.
    - [x] Log failure.
- [x] Implement `inject_error` function. (AC: 5, 6)
  - [x] Use `sed` to insert the warning callout after the second `---` delimiter.
  - [x] Strategy: Write to a temporary file, then overwrite original (safe atomic-like operation).
- [x] Implement Summary Reporting. (AC: 8)
  - [x] Track counters for `processed`, `success`, `failure`.
  - [x] Log final summary.
- [x] Testing & Verification.
  - [x] Create `misc/obsidian/infrastructure/tests/test-1.5-operations.sh`.
  - [x] Test cases: Success move, Collision detection, Invalid note move + error injection, Dry-run safety.
  - [x] Verify POSIX compliance (no `mv -n`, no `sed -i`).

...

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-19 | 1.0 | Initial draft for File Operations | John (PM) |
| 2026-01-19 | 1.1 | Technical enrichment and POSIX sed strategy | Bob (SM) |
| 2026-01-19 | 1.2 | Implemented file operations, error injection, and robust tests | James (Dev) |

## Dev Agent Record
### Agent Model Used
Gemini Pro 1.5 (James)

### Debug Log References
- Operations tests: 10/10 PASS (Success moves, Collisions, Error injection, Summary logs).
- Regression tests: 1.1, 1.3, 1.4 all PASS.

### Completion Notes List
- Implemented `process_file` orchestrating the full staging workflow.
- Implemented `inject_error` using portable `sed` `r` command to safe insertion.
- Implemented collision handling moving to `02-REFACTORING`.
- Updated `test-1.3-parsing.sh` to align with new validation rules and log formats.
- Verified system end-to-end with comprehensive test suite.

### File List
- misc/obsidian/infrastructure/scripts/stage.sh
- misc/obsidian/infrastructure/tests/test-1.3-parsing.sh
- misc/obsidian/infrastructure/tests/test-1.5-operations.sh

## QA Results

