# Story 1.4: Validation Logic Implementation

## Status
Ready for Review

## Story
**As a** Developer,
**I want** the script to validate notes against the loaded configuration rules,
**so that** I can correctly distinguish between "Valid" and "Invalid" notes.

## Acceptance Criteria
1. Script validates that a note has a "Type" that exists in the configuration. [Source: PRD-FR4]
2. Script validates required fields (where config value is `""`): field must exist in frontmatter and not be empty. [Source: PRD-FR5.1]
3. Script executes validation snippets (where config value is a string) using `eval`. [Source: PRD-FR5.2]
4. Validation snippets return 0 for success and non-zero for failure. [Source: PRD-FR5.2]
5. Script identifies a mandatory "ID" check (or other unique identifier) to prevent duplication. [Source: PRD-FR6]
6. Validation results (Pass/Fail + Reason) are tracked for each file and logged to stdout/logs. [Source: PRD-FR11]

## Tasks / Subtasks
- [x] Implement `validate_note` function in `stage.sh`. (AC: 1, 6)
  - [x] Extract `fields` object for the specific `Type` from the config JSON.
  - [x] Initialize an `errors` variable to collect failure reasons.
- [x] Implement Field Validation Loop. (AC: 2, 3, 4)
  - [x] Iterate over keys in the `fields` object using `jq`.
  - [x] For each field, check existence and value in the note's `metadata_json`.
  - [x] Handle `""` (existence check): Log error if missing or empty.
  - [x] Handle snippet check:
    - [x] Sanitize and prepare variables for `eval` (e.g., export metadata fields as variables).
    - [x] Run `eval "$snippet"` and check exit code `$?`.
    - [x] Collect errors if snippet fails.
- [x] Implement Mandatory ID Check. (AC: 5)
  - [x] Ensure `ID` field exists in metadata regardless of type config (or as a baseline requirement).
- [x] Testing & Verification.
  - [x] Create `misc/obsidian/infrastructure/tests/test-1.4-validation.sh`.
  - [x] Test cases: missing required field, failing snippet, passing all checks, missing ID.
  - [x] Verify POSIX compliance of the validation logic.

## Dev Notes
- **Implementation Strategy**: 
  - To expose metadata to `eval`, we can use a loop to generate variable assignments: `eval $(printf "%s" "$metadata_json" | jq -r 'to_entries[] | "\(.key)=\"\(.value)\""')`.
  - **Caution**: Since we are in `sh`, ensure the variable names are valid shell identifiers.
  - **Snippet Context**: Snippets in `staging-workflow.md` will look like `[ "$Status" = "Active" ]`. The `eval` will run this in the current shell context where `$Status` has been set.
- **Error Tracking**: Use a newline-separated string or a specific format that can be easily parsed or appended later in Story 1.5.
- **POSIX Constraints**: Avoid `local` variables. Use unique prefixing for internal function variables if necessary (e.g., `_v_field`, `_v_snippet`).

### Testing
- **Test file location:** `misc/obsidian/infrastructure/tests/test-1.4-validation.sh`
- **Verification steps**:
  1. Generate test data using `generate_test_data.sh`.
  2. Run `stage.sh --dry-run` and verify that `valid-idea.md` passes and `valid-note.md` passes.
  3. Verify that notes with missing fields or failing snippets are marked as `[FAIL]`.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-19 | 1.0 | Initial draft for Validation Logic | John (PM) |
| 2026-01-19 | 1.1 | Technical enrichment and implementation strategy | Bob (SM) |
| 2026-01-19 | 1.2 | Implemented validate_note and field validation loop | James (Dev) |

## Dev Agent Record
### Agent Model Used
Gemini Pro 1.5 (James)

### Debug Log References
- Logic implementation trace: Verified `validate_note` correctly identifies missing IDs and failing snippets.
- Regression tests: 1.1, 1.3, 1.4 all PASS.

### Completion Notes List
- Implemented `validate_note` using a robust `while read` loop for POSIX compatibility.
- Implemented `eval` based snippet validation with metadata exposure via subshell variable export.
- Ensured mandatory `ID` check for all notes.
- Created `test-1.4-validation.sh` covering positive and negative edge cases.

### File List
- misc/obsidian/infrastructure/scripts/stage.sh
- misc/obsidian/infrastructure/tests/test-1.4-validation.sh

## QA Results
(pending)

